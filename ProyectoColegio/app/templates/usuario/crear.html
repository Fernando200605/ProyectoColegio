{% extends 'create_generic.html' %}
{% load widget_tweaks %}

{% block titulo %}
  {{ titulo }}
{% endblock %}

{% block form %}
  {% csrf_token %}

  {# ===== FORMULARIO DE USUARIO ===== #}
  {% for field in usuario_form.visible_fields %}
    <div class="mb-4">
      <label class="form-label fw-bold" style="color: #1C2E4A;">
        {{ field.label }}
      </label>

      {# ── Campo PASSWORD con ojito ── #}
      {% if field.name == 'password' %}
        <div class="input-group">
          {{ field|add_class:'form-control form-control-custom'|attr:'id:id_password' }}
          <button class="btn btn-outline-secondary" type="button"
                  onclick="togglePassword('id_password', 'eye_password')"
                  tabindex="-1">
            <i id="eye_password" class="fas fa-eye"></i>
          </button>
        </div>
      {% else %}
        {{ field|add_class:'form-control form-control-custom' }}
      {% endif %}

      {% if field.errors %}
        {% for error in field.errors %}
          <div class="text-danger mt-1 small">
            <i class="fas fa-exclamation-circle me-1"></i> {{ error }}
          </div>
        {% endfor %}
      {% endif %}
    </div>

    {# ── Confirmar contraseña ── #}
    {% if field.name == 'password' %}
      <div class="mb-4">
        <label class="form-label fw-bold" style="color: #1C2E4A;">
          Confirmar Contraseña
        </label>
        <div class="input-group">
          <input type="password"
                 id="id_confirmar_password"
                 name="confirmar_password"
                 class="form-control form-control-custom"
                 placeholder="Repite la contraseña">
          <button class="btn btn-outline-secondary" type="button"
                  onclick="togglePassword('id_confirmar_password', 'eye_confirmar')"
                  tabindex="-1">
            <i id="eye_confirmar" class="fas fa-eye"></i>
          </button>
        </div>
      </div>
    {% endif %}
  {% endfor %}

  {# ===== SELECT DE ROL ===== #}
  <div class="mb-4">
    <label class="form-label fw-bold" style="color: #1C2E4A;">Rol</label>
    <select id="rol-select" name="rol" class="form-control" required>
      <option value="">Seleccione un rol</option>
      <option value="administrador" {% if rol_actual == 'administrador' %}selected{% endif %}>Administrador</option>
      <option value="docente"       {% if rol_actual == 'docente' %}selected{% endif %}>Docente</option>
      <option value="estudiante"    {% if rol_actual == 'estudiante' %}selected{% endif %}>Estudiante</option>
      <option value="acudiente"     {% if rol_actual == 'acudiente' %}selected{% endif %}>Acudiente</option>
    </select>
  </div>

  {# ===== FORMULARIOS POR ROL ===== #}

  <div id="administrador-form" class="rol-form" style="display:none;">
    <div class="mb-4">
      <label class="form-label fw-bold">Cargo</label>
      {{ admin_form.cargo|add_class:'form-control' }}
    </div>
  </div>

  <div id="docente-form" class="rol-form" style="display:none;">
    <div class="mb-4">
      <label class="form-label fw-bold">Especialidad</label>
      {{ docente_form.especialidad|add_class:'form-control' }}
    </div>
  </div>

<div id="estudiante-form" class="rol-form" style="display:none;">
  
  <div class="mb-4">
    <label class="form-label fw-bold">Código</label>
    {{ estudiante_form.codigo|add_class:'form-control' }}
  </div>

  <div class="mb-4">
    <label class="form-label fw-bold">Fecha de Nacimiento</label>
    {{ estudiante_form.fechaNacimiento|add_class:'form-control'|attr:'type:date' }}
  </div>

  <div class="mb-4">
    <label class="form-label fw-bold">Estado Matrícula</label>
    {{ estudiante_form.estadoMatricula|add_class:'form-control' }}
  </div>

  <div class="mb-4">
    <label class="form-label fw-bold">Fecha de Ingreso</label>
    {{ estudiante_form.fechaIngreso|add_class:'form-control'|attr:'type:date' }}
  </div>

  <div class="mb-4">
    <label class="form-label fw-bold">Curso</label>
    {{ estudiante_form.cursoId|add_class:'form-control' }}
  </div>

</div>

  <div id="acudiente-form" class="rol-form" style="display:none;">
    <div class="mb-4">
      <label class="form-label fw-bold">Teléfono</label>
      {{ acudiente_form.telefono|add_class:'form-control' }}
    </div>
    <div class="mb-4">
      <label class="form-label fw-bold">Dirección</label>
      {{ acudiente_form.direccion|add_class:'form-control' }}
    </div>
  </div>

  <script>
    function togglePassword(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon  = document.getElementById(iconId);

      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    }

    document.addEventListener('DOMContentLoaded', function () {

      const SOLO_LETRAS  = /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]$/;
      const SOLO_DIGITOS = /^\d$/;

      function bloquearTeclas(selector, regex) {
        document.querySelectorAll(selector).forEach(function (el) {
          el.addEventListener('keypress', function (e) {
            if (e.key.length > 1) return;
            if (!regex.test(e.key)) e.preventDefault();
          });

          el.addEventListener('paste', function (e) {
            const texto = (e.clipboardData || window.clipboardData).getData('text');
            if (!texto.split('').every(c => regex.test(c))) e.preventDefault();
          });
        });
      }

      bloquearTeclas(
        'input[name="nombre"], input[name="cargo"], input[name="especialidad"]',
        SOLO_LETRAS
      );

      bloquearTeclas(
        'input[name="codigo"], input[name="telefono"]',
        SOLO_DIGITOS
      );

      const rolSelect = document.getElementById('rol-select');
      const rolForms  = document.querySelectorAll('.rol-form');

      function toggleRolForm() {
        rolForms.forEach(div => {
          div.style.display = 'none';
          div.querySelectorAll('input, select, textarea').forEach(inp => {
            inp.disabled = true;
          });
        });

        if (rolSelect.value) {
          const formActivo = document.getElementById(rolSelect.value + '-form');
          if (formActivo) {
            formActivo.style.display = 'block';
            formActivo.querySelectorAll('input, select, textarea').forEach(inp => {
              inp.disabled = false;
            });
          }
        }
      }

      rolSelect.addEventListener('change', toggleRolForm);
      toggleRolForm();
    });
  </script>

{% endblock %}